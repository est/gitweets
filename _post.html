<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>login to gitweet</title>
</head>
<body onload="loader()">

<script type="text/javascript">
async function loader() {
  const Github = {
    CLIENT_ID: '822bbd6320f8bae0de63',
    REPO: 'CloudColonizer/gitweets',  // the original branch
    get_access_token: async function(code){
      // https://docs.github.com/en/apps/oauth-apps/building-oauth-apps/authorizing-oauth-apps#2-users-are-redirected-back-to-your-site-by-github
      const r = await fetch('https://f.est.im/github_oauth_proxy', {
        method: 'POST', mode: 'cors',
        headers: {'Accept': 'application/vnd.github+json', 'Content-Type': 'application/x-www-form-urlencoded'},
        body: new URLSearchParams({
          client_id: this.CLIENT_ID,
          code: code}),
        })
      const b = await r.json();
      console.log(b)
      return b.access_token
    },
    refresh_access_token: async function(){
      const params=new URL(document.location).searchParams;
      if(!params.get('access_token') && params.get('code')){
        this.access_token = await Github.get_access_token(params.get('code'))
        location.assign(location.pathname + '?access_token=' + this.access_token)
        return
      } else if (!params.get('access_token')){
        location.assign(
          'https://github.com/login/oauth/authorize?' +
          'scope=public_repo&client_id='+Github.CLIENT_ID+'&redirect_uri=' +
          location.origin+location.pathname+'%3Fclient_id='+Github.CLIENT_ID)
        return
      } else {
        Github.access_token = params.get('access_token')
        return Github.access_token
      }
    },
    call_api: async function(api, data){
      const options = {
        'method': Boolean(data)?'POST':'GET',
        'headers': {
          'Accept': 'application/vnd.github+json',
          'Authorization': 'Bearer ' + this.access_token,
          'X-GitHub-Api-Version': '2022-11-28',
      }}
      if(data!=undefined && typeof(data)=='object'){
        options['body'] = JSON.stringify(data)
      }
      if(typeof(arguments[2])==='object'){
        Object.assign(options, arguments[2])
      }
      const r = await fetch(api, options)
      return r
    },
    meta: async function(){
      'https://api.github.com/meta'
    },
    try_star: async function(repo){
      const r = await this.call_api('https://api.github.com/user/starred/'+repo, null, {method: 'PUT'})
      if (r.status == 204) document.write('Star '+repo+' success<br>')
      return r.text()
    },
    try_fork: async function(){
      const r = await this.call_api('https://api.github.com/repos/'+this.REPO+'/forks', {name: 'gitweets'})
      if (r.status == 202) document.write('Fork '+this.REPO+' success<br>')
      return await r.json()
    },
    find_messages: async function(){
      `{
        repository(owner: "CloudColonizer", name: "gitweets") {
          defaultBranchRef {
            target {
              ... on Commit {
                history(first: 12,path:"static/") {
                  nodes {
                    message
                    oid
                    file(path:"static/") {
                      object{
                        ... on Tree{
                          entries{
                            path
                            object {
                              ... on Tree{
                                oid
                                entries{
                                  path
                                  size
                                  # lineCount
                                  mode
                                  object{
                                    oid
                                    ... on Blob{
                                      byteSize
                                      isBinary
                                      abbreviatedOid
                                    }
                                  }
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }`
    },
    read_notes: async function(){
      `{
      repository(owner: "est", name: "gitweets") {
        refs(refPrefix:"refs/notes/",first:1) {
          nodes{
            ... on Ref{
              target {
                oid
                ... on Commit{
                  changedFilesIfAvailable
                  message
                  tree{
                    oid
                    entries{
                      oid
                      path
                      size
                      lineCount
                      mode
                      object{
                        ... on Blob{
                          byteSize
                          text
                        }
                      }
                    }
                  }
                }
                
              }
            }
          }
        }
      }
    }`
    },
    find_fork_treeid: async function(){
      /*
        query {
          repositoryOwner(login:"est"){
            repositories(first:100,isFork:true){
              nodes{
                nameWithOwner
                parent {
                  nameWithOwner
                }
              }
            }
          }
        }
      */
      const r = await this.call_api('https://api.github.com/graphql', {query: `{
        viewer {
          repositories(first: 100, isFork: true) {
            nodes {
              nameWithOwner
              defaultBranchRef{
                name
                target{
                  ... on Commit {
                    tree{
                      oid
                    }
                  }
                  oid
                }
              }
              parent {
                nameWithOwner
                defaultBranchRef{
                  name
                  target{
                    ... on Commit {
                      tree{
                        oid
                      }
                    }
                    oid
                  }
                }
              }
            }
          }
        }
      }`})
      const ret = await r.json()
      for (const repo of ret.data.viewer.repositories.nodes){
        if(repo.parent.nameWithOwner===this.REPO){
          return [{
            'repo': repo.parent.nameWithOwner,
            'branch': repo.parent.defaultBranchRef.name,
            'sha': repo.parent.defaultBranchRef.target.oid,
            'tree': repo.parent.defaultBranchRef.target.tree.oid
          }, {
            'repo': repo.nameWithOwner,
            'branch': repo.defaultBranchRef.name,
          }]
        }
      }
    },
    make_commit: async function(repo, sha, tree, msg, file){
      const r1 = await this.call_api('https://api.github.com/repos/'+repo+'/git/commits', {
        "message": msg,
        "parents": [sha],
        "tree": tree
      })
      const c = await r1.json()
      const tmp_branch = 'new_gitweets'
      const r2 = await this.call_api(
        'https://api.github.com/repos/'+repo+'/git/refs/heads/'+tmp_branch, null, {'method': 'DELETE'})
      const r3 = await this.call_api(
        'https://api.github.com/repos/'+repo+'/git/refs', {
          "ref": "refs/heads/"+tmp_branch, "sha": c['sha'], "force": true,
        })
      return r3
    },
    try_merge: async function(orig_repo, orig_branch, fork_repo, fork_branch){
      const [fu, fn] = fork_repo.split('/', 2)
      const r = await this.call_api('https://api.github.com/repos/'+orig_repo+'/pulls', {
        "title": "New posts from @"+fu,
        "body": "UA: "+navigator.userAgent+'\nReferrer: '+ document.referrer+'\nURL: '+location.href,
        "head": fu+":"+fork_branch, "head_repo": fn, "base": orig_branch,
        "maintainer_can_modify": true
      })
      return await r.json()
    }
  }
  if(await Github.refresh_access_token()){
    // await Github.try_star('cloudcolonizer/pioneers')
    // await Github.try_fork()
    // const repos = (await Github.call_api('https://api.github.com/user/repos')).json()
    const [orig, fork] = (await Github.find_fork_treeid())
    const r = await Github.make_commit(fork.repo, orig.sha, orig.tree, 'haha')
    if (r.status == 201) {
      await Github.try_merge(orig.repo, orig.branch, fork.repo, 'new_gitweets')
    } else {
      console.info((await r.json())?.message)
    }
  }
}
</script>
</body>
</html>
