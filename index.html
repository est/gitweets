<!DOCTYPE html><html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>gitweets</title>
	<style>
		body {
			font-family: sans-serif;
		}
		.banner {
			max-width: 45rem;
			margin: 0 auto 1rem auto;
			padding: 0.5rem 1rem;
			border: 1px solid #ccc;
			background-color: #f8f9fa;
			display: flex;
			align-items: center;
			gap: 1rem;
		}
		.banner h1 {margin: 0;}
		.banner h1 a {color: #1da1f2; font-size: 1.5rem; white-space: nowrap; text-decoration: none;}
		.banner-controls {
			display: flex;
			justify-content: flex-end;
			align-items: center;
			flex-grow: 1;
		}
		.banner input {
			flex-grow: 1;
			max-width: 20em;
			padding: 0.5rem;
			margin-right: 0.5rem;
			border: 1px solid #ccc;
			border-radius: 4px;
		}
		.banner button {
			margin-right: 0.5rem;
			border: 2px solid #1da1f2;
			border-radius: 4px;
			background-color: transparent;
			color: #1da1f2;
			cursor: pointer;
			transition: all 0.2s ease;
			font-size: 1.2rem;
			line-height: 1.5;
		}
		.banner button:hover {
			background-color: #e8f5fe;
			border-color: #0c85d0;
		}
		#timeline {
			flex-direction: column;
			max-width: 45rem;
			margin: 0 auto;
			padding: 1rem;
			border: 1px solid #ccc;
		}

	/* Loading indicator styles */
	#divStatus {
			display: flex;
			justify-content: center;
			align-items: center;
			padding: 1rem;
			border-radius: 8px;
			background-color: #f8f9fa;
			box-shadow: 0 2px 10px rgba(0,0,0,0.1);
			margin: 1rem auto;
			width: fit-content;
			font-size: 1.1rem;
			color: #555;
		}

		.tweet {
			display: flex;
			padding-right: 1rem;
			margin-bottom: 1em;
		}
		.tweet .avatar {
			margin-right: 1rem;
			width: 48px;
			height: 48px;
			border-radius: 50%;
		}
		.tweet .username {
			font-size: 16px;
			font-weight: bold;
		}
		.tweet .verified {
			color: blue;
		}
		.tweet .datetime {
			color:grey; font-size: 0.8em;
			text-decoration: none;
		}
		.tweet .tweet-content {
			max-width: 50em;
		}
		.tweet .tweet-content .medias {
			display: flex;
			flex-wrap: wrap;
			margin-collapse: collapse;
			list-style-type: none;
	    margin: 0;
	    padding-inline: 0;
		}
		.tweet .tweet-content li {
			margin-collapse: collapse;
			margin: 0 0.5rem 0.5rem 0;
			flex-basis: 48%;
			line-height: 0;
		}
		.tweet .tweet-content img {
			width: 100%;
		}
		.tweet .tweet-content pre {
			font-family: inherit;
			margin: 0;
			overflow-wrap: break-word;
			overflow-y: auto;
			color: #555;
		}

		/* Modal styles */
		.modal {display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4);}
		.modal-header {display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;}
		.modal-header h2 {margin: 0; color: #1da1f2;}
		.modal #btnClose {font-size: 1.5rem; cursor: pointer;}
		.modal-content {background-color: #fff; margin: 10% auto; padding: 1rem; border: 1px solid #888; width: 40em; border-radius: 8px;}
		.modal-body textarea {width: 100%; height: 150px; padding: 0.5rem; margin-bottom: 1rem; border: 1px solid #ccc; border-radius: 4px; resize: vertical; box-sizing: border-box;}
		.modal-footer {display: flex; justify-content: flex-end; gap: 0.5rem;}
		.modal-footer button {padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; background-color: #ccc; color: #333;}
		.modal #btnPost {background-color: #1da1f2; color: white;}
	</style>
</head>
<body onload="load_timeline()">
	<div class="banner">
		<h1><a href='/'>gitweets</a></h1>
		<div class="banner-controls">
			<input id="inputServer" list="optServers" placeholder="Select or type a server" value="">
			<datalist id="optServers">
				<option selected="selected" value="https://github.com/est/gitweets">
			</datalist>
			<button id="btnRefresh" onclick="load_timeline()">üîÑ</button>
			<button id="btnNewPost" onclick="openModal()">‚úèÔ∏è</button>
			<button id="btnPrev" disabled>‚¨ÖÔ∏è</button>
			<button id="btnNext">‚û°Ô∏è</button>
		</div>
	</div>
	<div id="timeline">
		<div id="divStatus">Loading...</div>
	</div>
	<!-- Modal for composing tweet -->
	<div id="composeModal" class="modal">
		<div class="modal-content">
			<div class="modal-header">
				<h2>‚úçÔ∏è</h2>
				<span id="btnClose" onclick="closeModal()">&times;</span>
			</div>
			<div class="modal-body">
				<textarea id="inputTweet" placeholder="What's up?"></textarea>
			</div>
			<div class="modal-footer">
				<button id="btnCancel" onclick="closeModal()">Cancel</button>
				<button id="btnPost">Post</button>
			</div>
		</div>
	</div>
	<script><!--
		// safe html
		const sh=s=>s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')  
		// show date
		const sd=d=>new Date(d.getTime() - d.getTimezoneOffset()*60_000).toISOString().replace('T', ' ').split('.')[0]

		// render timeline tweets
		function render(o){
			return `
		<div class="tweet" id="post-${encodeURI(o.id)}">
			<a href="/${encodeURI(o.author_slug)}"><img class="avatar" src="${encodeURI(o.author_avatar)}"></a>
			<div>
				<span class="username${o.author_verified?' verified':''}">${sh(o.author_name)}</span>
				<div class="tweet-content">
				  <pre style="${o.message.length>1024?'font:12px monospace':''}">${sh(o.message)}</pre>
				  <ul class="medias"></ul>
				</div>
				<a class="datetime" href="/${encodeURI(o.author_slug)}/${encodeURI(o.id)}">${sh(sd(o.date))}</a>
			</div>
		</div>
		`}

		function append_images(sha1_id, urls){
			const imgs = []
			urls.forEach(url=>{  // Ëß£ÊûêÂõæÁâáÁΩëÂùÄÔºåÂπ∂‰∏îÈáçÊñ∞ÊãºURLÔºåËäÇÁ∫¶‰∏ÄÊ¨°302Ë∑≥ËΩ¨
				const m = /\/([^\/]+)\/([^\/]+)\/raw\/([^\/]+)\/static%2F(.+.webp|.jpg|.jpeg|.png|.gif|.jxl|.avif)$/.exec(url)
				if (m){
					imgs.push(`<li><img src="https://raw.githubusercontent.com/${m[1]}/${m[2]}/${m[3]}/static/${decodeURIComponent(m[4])}"></li>`)
				}})
			timeline.querySelector('.tweet#post-'+sha1_id+' .tweet-content .medias').insertAdjacentHTML(
				'beforeend', imgs.join('\n'))
		}

		// load timeline 
		async function load_timeline(page){
			updatePaginationButtons();
			divStatus.style.display = 'block'
			divStatus.innerText = "Loading..."
			if (!inputServer.value) {
				inputServer.value = optServers.options[0].value
			}
			const servers = /github.com\/(\w+\/[\w\.]+)/.exec(inputServer.value)
			if (!servers) {
				divStatus.innerText = "bad server"
				return;
			}
			window.API_BASE = `https://api.github.com/repos/${servers[1]}`
			const params = {per_page: 10}
			if(page){
				params.page = page
			}else {
				params.page = currentPage
			}
			const m = /^\/(\w+)(?:\/([0-9a-fA-F]{40}))?$/.exec(location.pathname)
			if (m && m.length == 3 && m[2])
				params.sha = m[2]
			if (m && m.length >  1)
				params.author = m[1]

			var data;
			if (params.sha){
				data = [await (await fetch(`${API_BASE}/commits/${params.sha}`)).json()]
			}
			else{
				data = await (await fetch(`${API_BASE}/commits?${new URLSearchParams(params).toString()}`)).json()
			}
			timeline.querySelectorAll(':scope #divStatus ~ *').forEach(sib => sib.remove());
			if(data.length){
				divStatus.style.display = 'none'
			} else {
				divStatus.innerText='No data'
			}
			// format: https://docs.github.com/en/rest/commits/commits
			const media_ids = []
			data.forEach(item=>{
				timeline.insertAdjacentHTML('beforeend', render({
					id: item.sha,
					author_avatar: item.author.avatar_url,
					author_slug: item.author.login,
					author_verified: item.commit.verification?.verified,
					author_name: item.commit.author.name,
					message: item.commit.message,
					date: new Date(item.commit.author.date),
				}))
				// Ê∂àÊÅØ‰ª•ÂçäËßíÊàñËÄÖÂÖ®ËßíÂÜíÂè∑ÁªìÂ∞æÔºåË°®Á§∫ÊúâÂõæÁâá„ÄÇ
				if(!item.files && /(Ôºö|:)/.exec(item.commit.message.trim().slice(-1))){
					media_ids.push(item.sha)
				} else if (item.files) {
					append_images(item.sha, item.files.map(f=>f.raw_url))
				}
			})
			media_ids.forEach(async function(id){
				const r = await (await fetch(`${API_BASE}/commits/${id}`)).json()
				append_images(id, r.files.map(f=>f.raw_url))
			})
		}
		// do post
		async function post_new(access_token, text) {
			
		}
		import {getCookie} from './static/utils.js'

		// Modal functionality
		// Using element IDs directly
		function openModal() {
			if (getCookie(document.cookie, 'access_token')){
				btnPost.innerText = 'Post'
			} else {
				inputTweet.value = ''
				inputTweet.placeholder = 'Please login first'
				inputTweet.disabled = true
				btnPost.innerText = 'Login'
			}
			composeModal.style.display = 'block'
		}
		function closeModal() {
			inputTweet.value = ''
			inputTweet.placeholder = "What's up?"
			composeModal.style.display = 'none'
		}
		// Close modal when clicking outside the modal content
		window.addEventListener('click', function(event) {
			if (event.target == composeModal) {
				closeModal();
			}
		});
		window.addEventListener('keydown', function(event) {
			if (event.key === 'Escape') {
				closeModal();
			}
		});

		const OAUTH_URL =  "https://github.com/login/oauth/authorize?scope=public_repo&client_id=Ov23lirVyDKVPnHhDOFw"
		// bind post actions
		btnPost.addEventListener('click', async function() {
			const text = inputTweet.value.trim();
			const access_token = getCookie(document.cookie, 'access_token')
			if (access_token) {
				if (!text){
					inputTweet.placeholder = 'Type something here!'
					inputTweet.value = '';
					return
				}
				await post_new(access_token, text)
				closeModal();
				load_timeline(1)
			} else {
				location.href = OAUTH_URL
			}
		});

		// Pagination functionality
		const urlParams = new URLSearchParams(window.location.search);
		let currentPage = parseInt(urlParams.get('page')) || 1;		
		// Update pagination buttons state
		function updatePaginationButtons() {
			btnPrev.disabled = currentPage === 1;
		}
		// Previous page button
		btnPrev.addEventListener('click', function() {
			if (currentPage > 1) {
				currentPage--;
				if (currentPage === 1) {
					// Remove page parameter for first page
					const url = new URL(window.location);
					url.searchParams.delete('page');
					history.pushState(null, '', url);
				} else {
					history.pushState(null, '', `?page=${currentPage}`);
				}
				load_timeline(currentPage);
				updatePaginationButtons();
			}
		});
		// Next page button
		btnNext.addEventListener('click', function() {
			currentPage++;
			history.pushState(null, '', `?page=${currentPage}`);
			load_timeline(currentPage);
			updatePaginationButtons();
		});
		--></script>
</body>
</html>
